


<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps JavaScript API サンプル</title>
    <script type="text/javascript"
      src="https://maps-api-ssl.google.com/maps/api/js?key=AIzaSyBFjkHYZugsHhFbmR4dp72Q66YQNAkPqg8&callback=initMap"></script>
  </head>
  <body onload="initialize()">
    <p>Comfort Transport Test</p>

    <div id="map_canvas" style="width:500px; height:300px"></div>

    <script type="text/javascript">
      var map;
      var load_location_id = null;
      var bus_data_file = new XMLHttpRequest();
      var buses;
      var markers;
      var done_first_load = false;
      var last_update_sec;

      function initialize() { 
        var latlng = new google.maps.LatLng(35.680865,139.767036);
        var opts = {
          zoom: 14,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        
        var useragent = navigator.userAgent;
        var mapdiv = document.getElementById("map_canvas");
        if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1){
          mapdiv.style.width = '100%';
          mapdiv.style.height = '100%';
        }
        map = new google.maps.Map(mapdiv, opts);
      }

      function Bus(id, lat, lng, date){
        this.id = id;
        this.lat = lat;
        this.lng = lng;
        this.data = date;
      }

      function get_marker(bus){
        var m_latlng = new google.maps.LatLng(bus.lat, bus.lng);
        var marker = new google.maps.Marker({
          position: m_latlng
        });
        return marker
      }

      function pin_bus_locations(buses){
        for(var i=0; i<buses.length; i++){    
          markers[i] = get_marker(buses[i]);
          markers[i].setMap(map);
        }
      }
      
      bus_data_file.onload = function () {
        
        var text = bus_data_file.responseText
        var bus_data = JSON.parse(text);
        if(!done_first_load){
          buses = Array(bus_data.length);
          markers = Array(buses.length);
          for(var i=0; i<buses.length; i++){
            var id = bus_data[i]["@id"];
            var lat = bus_data[i]["geo:lat"];
            var lng = bus_data[i]["geo:long"];
            var date = bus_data[i]["dc:date"];
            buses[i] = new Bus(id, lat, lng, date);
          }
          var now = new Date();
          last_update_sec = now.getSeconds();
        }else{
          for(var i=0; i<bus_data.length; i++){
            var id = bus_data[i]["@id"];
            for(var j=0; j<buses.length; j++){
              if(id == buses[j].id){
                markers[j].setVisible(false);
                var lat = bus_data[i]["geo:lat"];
                var lng = bus_data[i]["geo:long"];
                if(buses[j].lat != lat && buses[j].lng != lng){
                  var now = new Date();
                  last_update_sec = now.getSeconds();
                  buses[j].lat = lat;
                  buses[j].lng = lng;
                }
                break;
              }
            }
          }
        }
        pin_bus_locations(buses);
        done_first_load = true;
      }

      function hex(s) {
        var result="";
        for(var i=0;i<s.length;++i){
          var h = ("0"+s.charCodeAt(i).toString(16)).substr(-2);
          result += h;
        }
        return result;
      }

      function PlotBusStop(url, icon_file){
        console.log(url)
　　　　var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status == 200) {
              var data = JSON.parse(xmlhttp.responseText);
              console.log(data.length)
              for (step = 0;step<data.length;step++) {
                console.log(data[step].lat)
                var m_latlng = new google.maps.LatLng(data[step].lat,data[step].lon);
                marker_url = getMarker(hex(data[step].routepattern)%8)
                console.log("print color")
                console.log(hex(data[step].routepattern)%8)
                console.log(marker_url)
                marker = new google.maps.Marker({
                  position: m_latlng,
                  title: url,
                  icon: {
                      url: marker_url
                  }
                });
                marker.setMap(map);
              }
            }
          }
        }
        xmlhttp.open("GET",url);
        xmlhttp.send();
      }

      function getMarker(id){
        marker_file="red-dot.png"
        if (id==0){
          marker_file="red-dot.png"
        } else if (id==1){
          marker_file="blue-dot.png"
        } else if (id==2){
          marker_file="green-dot.png"
        } else if (id==3){
          marker_file="ltblue-dot.png"
        } else if (id==4){
          marker_file="yellow-dot.png"
        } else if (id==5){
          marker_file="purple-dot.png"
        } else if (id==6){
          marker_file="pink-dot.png"
        } else if (id==7){
          marker_file="orange-dot.png"
        }
        return "http://unno.jpn.org/gmap/icons/"+marker_file
      }
      
      function load_location(){
        bus_data_file.open("GET", "https://api-tokyochallenge.odpt.org/api/v4/odpt:Bus?odpt:operator=odpt.Operator:SeibuBus&acl:consumerKey=2deef49e96744c2566cca5bb289318cd28490a662d82b8e62a071d32afe3fc3c");
        bus_data_file.send();
      }

      function update_time(){
        var now = new Date();
        var sec = (59 + now.getSeconds() - last_update_sec) % 60;
        var text = "最終更新から"+ sec +"秒";
        target = document.getElementById('time');
        target.innerHTML = text;
      }
      
      function toCurrent() {
        console.log("abs")
        console.log(hex("abc"))
        console.log(hex("abc")%9)

        function success(position) {
          marker.setVisible(false);
          map.panTo(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));
        };
        function error(err){
          switch(err.code) {
              case 1: // PERMISSION_DENIED
                window.alert("位置情報の利用が許可されていません");
                break;
              case 2: // POSITION_UNAVAILABLE
                window.alert("現在位置が取得できませんでした");
                break;
              case 3: // TIMEOUT
                window.alert("タイムアウトになりました");
                break;
              default:
                window.alert("その他のエラー(エラーコード:"+error.code+")");
                break;
            }
          output.innerHTML = "座標位置を取得できません";
        };
        var output = document.getElementById("result");
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(success, error);
        }   
        if (!navigator.geolocation){//Geolocation apiがサポートされていない場合
          output.innerHTML = "<p>Geolocationはあなたのブラウザーでサポートされておりません</p>";
          return;
        }
        
        // 30秒ごとにバス位置座標データを読み込む
        load_location();
        load_location_id = setInterval("load_location()", 30000);
        
        // 1秒ごとに最終更新時間の表示を更新
        update_time_id = setInterval("update_time()", 1000);

        // バス停座標を地図上にマーカー表示
        PlotBusStop("data0.json", "blue-dot.png")
        PlotBusStop("data1.json", "red-dot.png")
      }

    </script>

    <form>
    <p>
    <input type="button" id="current" value="現在位置" onclick="toCurrent()" />

    </p>
    <p id="time"></p>
    </form>
  </body>
</html>
