


<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps JavaScript API サンプル</title>
    <script type="text/javascript"
      src="https://maps-api-ssl.google.com/maps/api/js?key=AIzaSyBFjkHYZugsHhFbmR4dp72Q66YQNAkPqg8&callback=initMap"></script>
  </head>
  <body onload="initialize()">
    <p>Comfort Transport Test</p>

    <div id="map_canvas" style="width:500px; height:300px"></div>

    <script type="text/javascript">
      var map;
      var marker;
      var inforwindow;
      var timeout_id = null;
    
      function initialize() {
        
        var latlng = new google.maps.LatLng(35.680865,139.767036);
        var opts = {
          zoom: 14,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        
        var useragent = navigator.userAgent;
        var mapdiv = document.getElementById("map_canvas");
        if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1){
          mapdiv.style.width = '100%';
          mapdiv.style.height = '100%';
        }
        map = new google.maps.Map(mapdiv, opts);

        //map = new google.maps.Map(document.getElementById("map_canvas"), opts);
        marker = new google.maps.Marker({
          position: latlng
        });
        marker.setMap(map)
        marker.setVisible(false);

        
        infowindow = new google.maps.InfoWindow({
        });
        infowindow.open(map);
        infowindow.close();
      }

      function hex(s) {
        var result="";
        for(var i=0;i<s.length;++i){
          var h = ("0"+s.charCodeAt(i).toString(16)).substr(-2);
          result += h;
        }
        return result;
      }

      function PlotBusStop(url, icon_file){
        console.log(url)
　　　　var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status == 200) {
              var data = JSON.parse(xmlhttp.responseText);
              console.log(data.length)
              for (step = 0;step<data.length;step++) {
                console.log(data[step].lat)
                var m_latlng = new google.maps.LatLng(data[step].lat,data[step].lon);
                marker_url = getMarker(hex(data[step].routepattern)%8)
                console.log("print color")
                console.log(hex(data[step].routepattern)%8)
                console.log(marker_url)
                marker = new google.maps.Marker({
                  position: m_latlng,
                  title: url,
                  icon: {
                      url: marker_url
//                      url: "http://unno.jpn.org/gmap/icons/"+icon_file
                  }
                });
                marker.setMap(map);
              }
            }
          }
        }
        xmlhttp.open("GET",url);
        xmlhttp.send();
      }

      function getMarker(id){
        marker_file="red-dot.png"
        if (id==0){
          marker_file="red-dot.png"
        } else if (id==1){
          marker_file="blue-dot.png"
        } else if (id==2){
          marker_file="green-dot.png"
        } else if (id==3){
          marker_file="ltblue-dot.png"
        } else if (id==4){
          marker_file="yellow-dot.png"
        } else if (id==5){
          marker_file="purple-dot.png"
        } else if (id==6){
          marker_file="pink-dot.png"
        } else if (id==7){
          marker_file="orange-dot.png"
        }
        return "http://unno.jpn.org/gmap/icons/"+marker_file
      }

      function toTest() {
        clearTimeout(timeout_id)
        infowindow.close();
        marker.setVisible(false);
        map.panTo(new google.maps.LatLng(35.653697,139.726017));  
						     
        PlotBusStop("data0.json", "blue-dot.png")
        PlotBusStop("data1.json", "red-dot.png")
      }

      function toCurrent() {
        console.log("abs")
        console.log(hex("abc"))
        console.log(hex("abc")%9)

        function success(position) {
          marker.setVisible(false);
          map.panTo(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));
        };
        function error(err){
          switch(err.code) {
              case 1: // PERMISSION_DENIED
                window.alert("位置情報の利用が許可されていません");
                break;
              case 2: // POSITION_UNAVAILABLE
                window.alert("現在位置が取得できませんでした");
                break;
              case 3: // TIMEOUT
                window.alert("タイムアウトになりました");
                break;
              default:
                window.alert("その他のエラー(エラーコード:"+error.code+")");
                break;
            }
          output.innerHTML = "座標位置を取得できません";
        };
        var output = document.getElementById("result");
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(success, error);
        }   
        if (!navigator.geolocation){//Geolocation apiがサポートされていない場合
          output.innerHTML = "<p>Geolocationはあなたのブラウザーでサポートされておりません</p>";
          return;
        }

        // バス停座標を地図上にマーカー表示
        PlotBusStop("data0.json", "blue-dot.png")
        PlotBusStop("data1.json", "red-dot.png")
      }

    </script>

    <form>
    <p>
    <input type="button" id="current" value="現在位置" onclick="toCurrent()" />
    </p>
    </form>
  </body>
</html>
