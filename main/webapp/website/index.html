


<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps JavaScript API サンプル</title>
    <script type="text/javascript"
      src="https://maps-api-ssl.google.com/maps/api/js?key=AIzaSyBFjkHYZugsHhFbmR4dp72Q66YQNAkPqg8&callback=initMap"></script>
  </head>
  <body onload="initialize()">
    <p>Comfort Transport Test</p>

    <div id="map_canvas" style="width:500px; height:300px"></div>

    <script type="text/javascript">
      var map;
      var load_location_id = null;
      var bus_data_file = new XMLHttpRequest();
      var buses;
      var markers;
      var done_first_load = false;
      var last_update_sec;

    
      function initialize() { 
        var latlng = new google.maps.LatLng(35.680865,139.767036);
        var opts = {
          zoom: 14,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        
        var useragent = navigator.userAgent;
        var mapdiv = document.getElementById("map_canvas");
        if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1){
          mapdiv.style.width = '100%';
          mapdiv.style.height = '100%';
        }
        map = new google.maps.Map(mapdiv, opts);
      }

      function Bus(id, lat, lng, date){
        this.id = id;
        this.lat = lat;
        this.lng = lng;
        this.data = date;
      }


      function get_marker(bus){
        var m_latlng = new google.maps.LatLng(bus.lat, bus.lng);
        var marker = new google.maps.Marker({
          position: m_latlng
        });
        return marker
      }

      function pin_bus_locations(buses){
        for(var i=0; i<buses.length; i++){    
          markers[i] = get_marker(buses[i]);
          markers[i].setMap(map);
        }
      }
      
      bus_data_file.onload = function () {
        
        var text = bus_data_file.responseText
        var bus_data = JSON.parse(text);
        if(!done_first_load){
          buses = Array(bus_data.length);
          markers = Array(buses.length);
          for(var i=0; i<buses.length; i++){
            var id = bus_data[i]["@id"];
            var lat = bus_data[i]["geo:lat"];
            var lng = bus_data[i]["geo:long"];
            var date = bus_data[i]["dc:date"];
            buses[i] = new Bus(id, lat, lng, date);
          }
          var now = new Date();
          last_update_sec = now.getSeconds();
        }else{
          for(var i=0; i<bus_data.length; i++){
            var id = bus_data[i]["@id"];
            for(var j=0; j<buses.length; j++){
              if(id == buses[j].id){
                markers[j].setVisible(false);
                var lat = bus_data[i]["geo:lat"];
                var lng = bus_data[i]["geo:long"];
                if(buses[j].lat != lat && buses[j].lng != lng){
                  var now = new Date();
                  last_update_sec = now.getSeconds();
                  buses[j].lat = lat;
                  buses[j].lng = lng;
                }
                break;
              }
            }
          }
        }
        pin_bus_locations(buses);
        done_first_load = true;
      }
      
      function load_location(){
        bus_data_file.open("GET", "https://api-tokyochallenge.odpt.org/api/v4/odpt:Bus?odpt:operator=odpt.Operator:SeibuBus&acl:consumerKey=2deef49e96744c2566cca5bb289318cd28490a662d82b8e62a071d32afe3fc3c");
        bus_data_file.send();
      }

      load_location();
      load_location_id = setInterval("load_location()", 30000);
      update_time_id = setInterval("update_time()", 1000);


      function update_time(){
        var now = new Date();
        var sec = (59 + now.getSeconds() - last_update_sec) % 60;
        var text = "最終更新から"+ sec +"秒";
        target = document.getElementById('time');
        target.innerHTML = text;
      }
      

      
      function toCurrent() {
        function success(position) {
          map.panTo(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));
        };
        function error(err){
          switch(err.code) {
              case 1: // PERMISSION_DENIED
                window.alert("位置情報の利用が許可されていません");
                break;
              case 2: // POSITION_UNAVAILABLE
                window.alert("現在位置が取得できませんでした");
                break;
              case 3: // TIMEOUT
                window.alert("タイムアウトになりました");
                break;
              default:
                window.alert("その他のエラー(エラーコード:"+error.code+")");
                break;
            }
          output.innerHTML = "座標位置を取得できません";
        };
        var output = document.getElementById("result");
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(success, error);
        }   
        if (!navigator.geolocation){//Geolocation apiがサポートされていない場合
          output.innerHTML = "<p>Geolocationはあなたのブラウザーでサポートされておりません</p>";
          return;
        }
      }

    </script>

    <form>
    <p>
    <input type="button" id="current" value="現在位置" onclick="toCurrent()" />

    </p>
    <p id="time"></p>
    </form>
  </body>
</html>