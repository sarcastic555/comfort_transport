


<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps JavaScript API サンプル</title>
    <script type="text/javascript"
      src="https://maps-api-ssl.google.com/maps/api/js?key=AIzaSyBFjkHYZugsHhFbmR4dp72Q66YQNAkPqg8&callback=initMap"></script>
  </head>
  <body onload="initialize()">
    <p>Comfort Transport Test</p>

    <div id="map_canvas" style="width:700px; height:700px"></div>

    <script type="text/javascript">
      var map;
      var load_location_id = null;
      var bus_data_file = new XMLHttpRequest();
      var buses;
      var num_colors = 8;
      var done_first_load = false;
      var last_update_sec;

//      var bus_location_example = [
//        {lat: 35.794675, lng: 139.540672},
//        {lat: 35.793030, lng: 139.539191},
//        {lat: 35.791072, lng: 139.537281},
//        {lat: 35.789305, lng: 139.537935},
//        {lat: 35.788939, lng: 139.537044},
//        {lat: 35.787660, lng: 139.534029},
//        {lat: 35.786294, lng: 139.530531}
//      ]
      var bus_location_example = [
        { location: new google.maps.LatLng(35.794675, 139.540672) },
        { location: new google.maps.LatLng(35.793030, 139.539191) },
        { location: new google.maps.LatLng(35.791072, 139.537281) },
        { location: new google.maps.LatLng(35.789305, 139.537935) },
        { location: new google.maps.LatLng(35.788939, 139.537044) },
        { location: new google.maps.LatLng(35.787660, 139.534029) },
        { location: new google.maps.LatLng(35.786294, 139.530531) },
      ]

      function initialize() { 
        var latlng = new google.maps.LatLng(35.680865,139.767036);
        var opts = {
          zoom: 14,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        
        var useragent = navigator.userAgent;
        var mapdiv = document.getElementById("map_canvas");
        if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1){
          mapdiv.style.width = '100%';
          mapdiv.style.height = '100%';
        }
        map = new google.maps.Map(mapdiv, opts);
      };

      function Bus(lat, lng, date, number){
        this.lat = lat;
        this.lng = lng;
        this.data = date;
        this.number = number;
        var m_latlng = new google.maps.LatLng(lat, lng);
        hash_key = number % num_colors;
        var img_url = './bus_img/' + hash_key.toString(10) + '.png';
        var image = {
          url : img_url,
          scaledSize : new google.maps.Size(48, 48)
        };
        this.marker = new google.maps.Marker({
          position: m_latlng,
          icon:image
        });
//        console.log(this.marker)
      };

      function get_marker(bus){
        var m_latlng = new google.maps.LatLng(bus.lat, bus.lng);
        var marker = new google.maps.Marker({
          position: m_latlng
        });
        return marker
      };

      function bus_move(bus, lat, lng){
        bus.lat = lat;
        bus.lng = lng;
        bus.marker.setPosition(new google.maps.LatLng(lat, lng));
      }

      function pin_bus_locations(buses){
        for(var i=0; i<buses.length; i++){    
          buses[i].marker.setMap(map);
        }
      };
      
      bus_data_file.onload = function () {
        
        var text = bus_data_file.responseText
        var bus_data = JSON.parse(text);
        if(!done_first_load){
          buses = Array(bus_data.length);
          for(var i=0; i<buses.length; i++){
            var lat = bus_data[i]["geo:lat"];
            var lng = bus_data[i]["geo:long"];
            var date = bus_data[i]["dc:date"];
            var number = Number(bus_data[i]["odpt:busNumber"]);
            buses[i] = new Bus(lat, lng, date, number);
          }
          var now = new Date();
          last_update_sec = now.getSeconds();
        }else{
          for(var i=0; i<bus_data.length; i++){
            var number = Number(bus_data[i]["odpt:busNumber"]);
            for(var j=0; j<buses.length; j++){
              if(buses[j].number == number){
                var lat = bus_data[i]["geo:lat"];
                var lng = bus_data[i]["geo:long"];
                if(buses[j].lat != lat && buses[j].lng != lng){
                  var now = new Date();
                  last_update_sec = now.getSeconds();
                  bus_move(buses[j], lat, lng);
                }
                break;
              }
            }
          }
        }
        pin_bus_locations(buses);
        done_first_load = true;
      };

      function hex(s) {
        console.log("function hex(s)")
        console.log(s)
        var result="";
        for(var i=0;i<s.length;++i){
          var h = ("0"+s.charCodeAt(i).toString(16)).substr(-2);
          result += h;
        }
        return result;
      };

      function PlotBusStop(url, icon_file){
        console.log(url);
　　　　var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status == 200) {
              var data = JSON.parse(xmlhttp.responseText);
              //console.log(data.length);
              for (step = 0;step<data.length;step++) {
                //console.log(data[step].lat);
                //console.log(data[step].lon);
                var m_latlng = new google.maps.LatLng(data[step].lat,data[step].lon);
                //console.log(hex(data[step].busroutePattern)%8);
                //marker_url = getMarker(hex(data[step].busroutePattern)%8);
                //marker_url = getMarker(hex("aho")%8);
                marker_url = "http://unno.jpn.org/gmap/icons/blue-dot.png"
                //console.log("print color");
                //console.log(marker_url);
                marker = new google.maps.Marker({
                  position: m_latlng,
                  title: url,
                  icon: {
                      url: marker_url
                  }
                });
                marker.setMap(map);
              }
            }
          }
        }
        xmlhttp.open("GET",url);
        xmlhttp.send();
      };

      function getMarker(id){
        marker_file="red-dot.png"
        if (id==0){
          marker_file="red-dot.png"
        } else if (id==1){
          marker_file="blue-dot.png"
        } else if (id==2){
          marker_file="green-dot.png"
        } else if (id==3){
          marker_file="ltblue-dot.png"
        } else if (id==4){
          marker_file="yellow-dot.png"
        } else if (id==5){
          marker_file="purple-dot.png"
        } else if (id==6){
          marker_file="pink-dot.png"
        } else if (id==7){
          marker_file="orange-dot.png"
        }
        return "http://unno.jpn.org/gmap/icons/"+marker_file
      };
      
      function load_location(){
        bus_data_file.open("GET", "https://api-tokyochallenge.odpt.org/api/v4/odpt:Bus?odpt:operator=odpt.Operator:SeibuBus&acl:consumerKey=2deef49e96744c2566cca5bb289318cd28490a662d82b8e62a071d32afe3fc3c");
        //bus_data_file.open("GET", "https://api-tokyochallenge.odpt.org/api/v4/odpt:Bus?odpt:operator=odpt.Operator:Toei&acl:consumerKey=2deef49e96744c2566cca5bb289318cd28490a662d82b8e62a071d32afe3fc3c");
        bus_data_file.send();
      };

      function update_time(){
        var now = new Date();
        var sec = (60 + now.getSeconds() - last_update_sec) % 60;
        var text = "最終更新から"+ sec +"秒";
        target = document.getElementById('time');
        target.innerHTML = text;
      };
      
      function toCurrent() {
        console.log("abs")
        console.log(hex("abc"))
        console.log(hex("abc")%9)
        
        // 30秒ごとにバス位置座標データを読み込む
        load_location();
        load_location_id = setInterval("load_location()", 30000);
        
        // 1秒ごとに最終更新時間の表示を更新
        console.log("update map")
        update_time_id = setInterval("update_time()", 1000);

        // バス停座標を地図上にマーカー表示
        let bus_company_list = ["Toei", "KantoBus", "SeibuBus", "KokusaiKogyoBus", "NishiTokyoBus", "TokyuBus"];
        for(let i = 0; i < bus_company_list.length; i++) {
          PlotBusStop("busstop_data/coord_busstops_"+bus_company_list[i]+".json", "blue-dot.png")
        }

        // バスルート表示
        var directionsService = new google.maps.DirectionsService();
        var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});

        directionsDisplay.setMap(map);
        var route_request = {
//           origin: { location: new google.maps.LatLng(35.681565,139.920046) },
          origin: bus_location_example[0],
//           destination: { location: new google.maps.LatLng(35.68369,139.908180) },
          destination: bus_location_example[bus_location_example.length-1],
          waypoints: bus_location_example.slice(1, bus_location_example.length-1),
//          waypoints: [
//            { location: new google.maps.LatLng(35.684961,139.930923) },
//            { location: new google.maps.LatLng(35.685,139.958180) },
//            {lat: 35.684961, lng: 139.930923},
//            {lat: 35.685, lng: 139.958180},
//            {lat: 35.686691, lng: 139.908180},
//          ],
          travelMode: 'DRIVING'
        };
        directionsService.route(route_request, function(route_result, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(route_result);
          } else {
            console.log("direction service error")
          }
        });

        function success(position) {
          map.panTo(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));
        };
        function error(err){
          switch(err.code) {
              case 1: // PERMISSION_DENIED
                window.alert("位置情報の利用が許可されていません");
                break;
              case 2: // POSITION_UNAVAILABLE
                window.alert("現在位置が取得できませんでした");
                break;
              case 3: // TIMEOUT
                window.alert("タイムアウトになりました");
                break;
              default:
                window.alert("その他のエラー(エラーコード:"+error.code+")");
                break;
            }
          output.innerHTML = "座標位置を取得できません";
        };
        var output = document.getElementById("result");
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(success, error);
        }   
        if (!navigator.geolocation){//Geolocation apiがサポートされていない場合
          output.innerHTML = "<p>Geolocationはあなたのブラウザーでサポートされておりません</p>";
          return;
        }

      };

    </script>

    <form>
    <p>
    <input type="button" id="current" value="現在位置" onclick="toCurrent()" />
    </p>
    <p id="time"></p>
    </form>
  </body>
</html>
